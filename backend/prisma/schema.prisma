// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
   provider = "prisma-client-js"
}

datasource db {
   provider = "postgresql"
   url      = env("DATABASE_URL")
}

enum UserRole {
   SUPER_ADMIN
   ORG_ADMIN
   TEAM_OWNER
   TEAM_ADMIN
   PROJECT_MANAGER
   MEMBER
}

enum TeamRole {
   OWNER
   ADMIN
   MEMBER
}

enum ProjectStatus {
   ACTIVE
   ARCHIVED
}

enum TaskStatus {
   BACKLOG
   TODO
   IN_PROGRESS
   REVIEW
   DONE
   BLOCKED
}

enum TaskPriority {
   LOW
   MEDIUM
   HIGH
   CRITICAL
}

enum IssueSeverity {
   MINOR
   MAJOR
   CRITICAL
   BLOCKER
}

enum IssueStatus {
   OPEN
   IN_PROGRESS
   RESOLVED
   CLOSED
   REOPENED
}

model User {
   id           String   @id @default(uuid())
   email        String   @unique
   passwordHash String   @map("password_hash")
   firstName    String   @map("first_name")
   lastName     String   @map("last_name")
   role         UserRole @default(MEMBER)
   isActive     Boolean  @default(true) @map("is_active")
   createdAt    DateTime @default(now()) @map("created_at")
   updatedAt    DateTime @updatedAt @map("updated_at")

   // Relations
   teamMemberships TeamMember[]
   createdTasks    Task[]       @relation("TaskCreator")
   assignedTasks   Task[]       @relation("TaskAssignee")

   @@map("users")
}

model Team {
   id          String   @id @default(uuid())
   name        String
   description String?
   createdAt   DateTime @default(now()) @map("created_at")
   updatedAt   DateTime @updatedAt @map("updated_at")

   // Relations
   members  TeamMember[]
   projects Project[]

   @@map("teams")
}

model TeamMember {
   id        String   @id @default(uuid())
   teamId    String   @map("team_id")
   userId    String   @map("user_id")
   role      TeamRole @default(MEMBER)
   joinedAt  DateTime @default(now()) @map("joined_at")
   updatedAt DateTime @updatedAt @map("updated_at")

   // Relations
   team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
   user User @relation(fields: [userId], references: [id], onDelete: Cascade)

   @@unique([teamId, userId])
   @@map("team_members")
}

model Project {
   id          String        @id @default(uuid())
   teamId      String        @map("team_id")
   name        String
   key         String
   description String?
   status      ProjectStatus @default(ACTIVE)
   createdAt   DateTime      @default(now()) @map("created_at")
   updatedAt   DateTime      @updatedAt @map("updated_at")

   // Relations
   team   Team    @relation(fields: [teamId], references: [id], onDelete: Cascade)
   tasks  Task[]
   issues Issue[]

   @@unique([teamId, key])
   @@map("projects")
}

model Task {
   id          String       @id @default(uuid())
   projectId   String       @map("project_id")
   title       String
   description String?
   status      TaskStatus   @default(TODO)
   priority    TaskPriority @default(MEDIUM)
   createdBy   String       @map("created_by")
   createdAt   DateTime     @default(now()) @map("created_at")
   updatedAt   DateTime     @updatedAt @map("updated_at")

   // Relations
   project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
   creator   User    @relation("TaskCreator", fields: [createdBy], references: [id])
   assignees User[]  @relation("TaskAssignee")
   issues    Issue[]

   @@map("tasks")
}

model Issue {
   id          String        @id @default(uuid())
   projectId   String?       @map("project_id")
   taskId      String?       @map("task_id")
   title       String
   description String
   severity    IssueSeverity
   status      IssueStatus   @default(OPEN)
   createdAt   DateTime      @default(now()) @map("created_at")
   updatedAt   DateTime      @updatedAt @map("updated_at")

   // Relations
   project Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
   task    Task?    @relation(fields: [taskId], references: [id], onDelete: Cascade)

   @@map("issues")
}
