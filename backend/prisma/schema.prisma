// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
   provider = "prisma-client-js"
}

datasource db {
   provider = "postgresql"
   url      = env("DATABASE_URL")
}

enum UserRole {
   CEO
   HOO
   HR
   ADMIN
   STAFF
}

enum Department {
   OPS
   HR
}

enum TaskStatus {
   DRAFT
   ASSIGNED
   IN_PROGRESS
   PAUSED
   REVIEW
   COMPLETED
   REJECTED
}

enum TaskPriority {
   LOW
   MEDIUM
   HIGH
}

enum IssueType {
   TASK
   BUG
   STORY
}

enum ActivityAction {
   CREATE
   ASSIGN
   APPROVE
   REJECT
   STATUS_UPDATE
   COMMENT
}

enum NotificationType {
   TASK_ASSIGNED
   STATUS_CHANGED
   COMMENT
   MENTION
   APPROVAL_REQUIRED
   APPROVED
   REJECTED
}

enum DependencyType {
   BLOCKS
   IS_BLOCKED_BY
   RELATES_TO
}

enum SprintStatus {
   PLANNING
   ACTIVE
   COMPLETED
   CANCELLED
}

model User {
   id           String      @id @default(uuid())
   email        String      @unique
   passwordHash String      @map("password_hash")
   name         String
   role         UserRole    @default(STAFF)
   department   Department?
   isActive     Boolean     @default(true) @map("is_active")
   createdAt    DateTime    @default(now()) @map("created_at")
   updatedAt    DateTime    @updatedAt @map("updated_at")

   // Relations
   createdProjects Project[]         @relation("ProjectCreator")
   createdTasks    Task[]            @relation("TaskCreator")
   assignedTasks   Task[]            @relation("TaskAssignee")
   approvedTasks   Task[]            @relation("TaskApprover")
   comments        TaskComment[]
   activityLogs    TaskActivityLog[]
   notifications   Notification[]
   watchedTasks    Task[]            @relation("TaskWatchers")
   timeEntries     TimeEntry[]
   activeTimer     ActiveTimer?
   attachments     TaskAttachment[]  @relation("TaskAttachmentUploader")

   @@map("users")
}

model Project {
   id          String      @id @default(uuid())
   name        String
   description String?
   department  Department?
   creatorId   String      @map("creator_id")
   createdAt   DateTime    @default(now()) @map("created_at")
   updatedAt   DateTime    @updatedAt @map("updated_at")

   // Relations
   creator User     @relation("ProjectCreator", fields: [creatorId], references: [id])
   tasks   Task[]
   epics   Epic[]
   sprints Sprint[]

   @@map("projects")
}

model Task {
   id               String       @id @default(uuid())
   projectId        String?      @map("project_id")
   title            String
   description      String?
   priority         TaskPriority @default(MEDIUM)
   issueType        IssueType    @default(TASK) @map("issue_type")
   status           TaskStatus   @default(DRAFT)
   creatorId        String       @map("creator_id")
   assigneeId       String?      @map("assignee_id")
   parentTaskId     String?      @map("parent_task_id")
   requiresApproval Boolean      @default(false) @map("requires_approval")
   approvedById     String?      @map("approved_by_id")
   rejectionReason  String?      @map("rejection_reason")
   labels           String[]     @default([])
   dueDate          DateTime?    @map("due_date")
   estimatedHours   Float?       @map("estimated_hours")
   loggedHours      Float        @default(0) @map("logged_hours")
   storyPoints      Int?         @map("story_points")
   epicId           String?      @map("epic_id")
   sprintId         String?      @map("sprint_id")
   createdAt        DateTime     @default(now()) @map("created_at")
   updatedAt        DateTime     @updatedAt @map("updated_at")

   // Relations
   project      Project?          @relation(fields: [projectId], references: [id], onDelete: Cascade)
   creator      User              @relation("TaskCreator", fields: [creatorId], references: [id])
   assignee     User?             @relation("TaskAssignee", fields: [assigneeId], references: [id])
   approvedBy   User?             @relation("TaskApprover", fields: [approvedById], references: [id])
   parentTask   Task?             @relation("SubTasks", fields: [parentTaskId], references: [id])
   subTasks     Task[]            @relation("SubTasks")
   comments     TaskComment[]
   activityLogs TaskActivityLog[]
   watchers     User[]            @relation("TaskWatchers")
   dependentOn  TaskDependency[]  @relation("DependentTask")
   blocking     TaskDependency[]  @relation("BlockingTask")
   timeEntries  TimeEntry[]
   activeTimers ActiveTimer[]
   attachments  TaskAttachment[]
   epic         Epic?             @relation(fields: [epicId], references: [id])
   sprint       Sprint?           @relation(fields: [sprintId], references: [id])

   @@map("tasks")
}

model TaskComment {
   id        String   @id @default(uuid())
   taskId    String   @map("task_id")
   userId    String   @map("user_id")
   message   String
   createdAt DateTime @default(now()) @map("created_at")

   // Relations
   task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
   user User @relation(fields: [userId], references: [id])

   @@map("task_comments")
}

model TaskActivityLog {
   id             String         @id @default(uuid())
   taskId         String         @map("task_id")
   userId         String         @map("user_id")
   action         ActivityAction
   previousStatus TaskStatus?    @map("previous_status")
   newStatus      TaskStatus?    @map("new_status")
   metadata       Json?
   timestamp      DateTime       @default(now())

   // Relations
   task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
   user User @relation(fields: [userId], references: [id])

   @@map("task_activity_logs")
}

model Notification {
   id        String           @id @default(uuid())
   userId    String           @map("user_id")
   type      NotificationType
   payload   Json
   read      Boolean          @default(false)
   createdAt DateTime         @default(now()) @map("created_at")

   // Relations
   user User @relation(fields: [userId], references: [id], onDelete: Cascade)

   @@map("notifications")
}

model TaskDependency {
   id              String         @id @default(uuid())
   dependentTaskId String         @map("dependent_task_id")
   blockingTaskId  String         @map("blocking_task_id")
   type            DependencyType @default(BLOCKS)
   createdAt       DateTime       @default(now()) @map("created_at")

   // Relations
   dependentTask Task @relation("DependentTask", fields: [dependentTaskId], references: [id], onDelete: Cascade)
   blockingTask  Task @relation("BlockingTask", fields: [blockingTaskId], references: [id], onDelete: Cascade)

   @@unique([dependentTaskId, blockingTaskId])
   @@map("task_dependencies")
}

model TimeEntry {
   id          String   @id @default(uuid())
   taskId      String   @map("task_id")
   userId      String   @map("user_id")
   hours       Float
   description String?
   date        DateTime @default(now())
   createdAt   DateTime @default(now()) @map("created_at")
   updatedAt   DateTime @updatedAt @map("updated_at")

   // Relations
   task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
   user User @relation(fields: [userId], references: [id])

   @@map("time_entries")
}

model ActiveTimer {
   id          String   @id @default(uuid())
   taskId      String   @map("task_id")
   userId      String   @unique @map("user_id")
   startTime   DateTime @map("start_time")
   description String?

   // Relations
   task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
   user User @relation(fields: [userId], references: [id], onDelete: Cascade)

   @@map("active_timers")
}

model TaskAttachment {
   id           String   @id @default(uuid())
   taskId       String   @map("task_id")
   uploadedById String   @map("uploaded_by_id")
   fileName     String   @map("file_name")
   originalName String   @map("original_name")
   filePath     String   @map("file_path")
   mimeType     String   @map("mime_type")
   fileSize     Int      @map("file_size")
   createdAt    DateTime @default(now()) @map("created_at")

   // Relations
   task       Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
   uploadedBy User @relation("TaskAttachmentUploader", fields: [uploadedById], references: [id])

   @@map("task_attachments")
}

model Epic {
   id          String    @id @default(uuid())
   projectId   String    @map("project_id")
   name        String
   description String?
   color       String?
   startDate   DateTime? @map("start_date")
   endDate     DateTime? @map("end_date")
   createdAt   DateTime  @default(now()) @map("created_at")
   updatedAt   DateTime  @updatedAt @map("updated_at")

   // Relations
   project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
   tasks   Task[]

   @@map("epics")
}

model Sprint {
   id            String       @id @default(uuid())
   projectId     String       @map("project_id")
   name          String
   goal          String?
   status        SprintStatus @default(PLANNING)
   startDate     DateTime?    @map("start_date")
   endDate       DateTime?    @map("end_date")
   capacityHours Float?       @map("capacity_hours")
   completedAt   DateTime?    @map("completed_at")
   createdAt     DateTime     @default(now()) @map("created_at")
   updatedAt     DateTime     @updatedAt @map("updated_at")

   // Relations
   project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
   tasks   Task[]

   @@map("sprints")
}
