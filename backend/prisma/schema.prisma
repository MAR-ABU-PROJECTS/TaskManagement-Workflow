// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Management
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String    @map("password_hash")
  firstName     String    @map("first_name")
  lastName      String    @map("last_name")
  role          UserRole
  isActive      Boolean   @default(true) @map("is_active")
  lastLoginAt   DateTime? @map("last_login_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  ownedTeams        Team[]          @relation("TeamOwner")
  teamMembers       TeamMember[]
  ownedProjects     Project[]       @relation("ProjectOwner")
  projectMembers    ProjectMember[]
  assignedTasks     Task[]          @relation("TaskAssignee")
  reportedTasks     Task[]          @relation("TaskReporter")
  assignedIssues    Issue[]         @relation("IssueAssignee")
  reportedIssues    Issue[]         @relation("IssueReporter")
  comments          Comment[]
  timeEntries       TimeEntry[]
  notifications     Notification[]
  auditLogs         AuditLog[]
  userPermissions   UserPermission[]
  ownedEpics        Epic[]          @relation("EpicOwner")
  refinementSessions BacklogRefinement[] @relation("RefinementFacilitator")
  estimationSessions EstimationSession[] @relation("EstimationFacilitator")

  @@map("users")
}

enum UserRole {
  ADMIN
  PROJECT_MANAGER
  TEAM_LEAD
  DEVELOPER
  VIEWER

  @@map("user_role")
}

model UserPermission {
  id       String @id @default(cuid())
  userId   String @map("user_id")
  resource String
  actions  String[]
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, resource])
  @@map("user_permissions")
}

// Team Management (New hierarchy level)
model Team {
  id          String     @id @default(cuid())
  name        String
  description String?
  key         String     @unique // e.g., "TEAM-DEV"
  ownerId     String     @map("owner_id")
  isActive    Boolean    @default(true) @map("is_active")
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  // Relations
  owner    User          @relation("TeamOwner", fields: [ownerId], references: [id])
  members  TeamMember[]
  projects Project[]

  @@map("teams")
}

model TeamMember {
  id          String   @id @default(cuid())
  teamId      String   @map("team_id")
  userId      String   @map("user_id")
  role        TeamRole
  permissions String[]
  joinedAt    DateTime @default(now()) @map("joined_at")

  // Relations
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@map("team_members")
}

enum TeamRole {
  LEAD
  SENIOR_DEVELOPER
  DEVELOPER
  JUNIOR_DEVELOPER
  TESTER
  DESIGNER

  @@map("team_role")
}

// Project Management
model Project {
  id          String            @id @default(cuid())
  name        String
  description String?
  key         String            @unique // e.g., "MAR-001"
  methodology ProjectMethodology
  status      ProjectStatus
  startDate   DateTime?         @map("start_date")
  endDate     DateTime?         @map("end_date")
  budget      Decimal?          @db.Decimal(12, 2)
  priority    Priority?
  teamId      String            @map("team_id")
  ownerId     String            @map("owner_id")
  createdAt   DateTime          @default(now()) @map("created_at")
  updatedAt   DateTime          @updatedAt @map("updated_at")

  // Relations
  team          Team            @relation(fields: [teamId], references: [id])
  owner         User            @relation("ProjectOwner", fields: [ownerId], references: [id])
  members       ProjectMember[]
  tasks         Task[]
  issues        Issue[]
  sprints       Sprint[]
  workflows     Workflow[]
  customFields  CustomField[]
  backlogs      Backlog[]
  epics         Epic[]
  estimationSessions EstimationSession[]
  configuration ProjectConfiguration?

  @@map("projects")
}

enum ProjectMethodology {
  AGILE
  WATERFALL
  KANBAN
  HYBRID

  @@map("project_methodology")
}

enum ProjectStatus {
  PLANNING
  ACTIVE
  ON_HOLD
  COMPLETED
  CANCELLED

  @@map("project_status")
}

enum Priority {
  LOWEST
  LOW
  MEDIUM
  HIGH
  HIGHEST

  @@map("priority")
}

model ProjectMember {
  id          String      @id @default(cuid())
  projectId   String      @map("project_id")
  userId      String      @map("user_id")
  role        ProjectRole
  permissions String[]
  joinedAt    DateTime    @default(now()) @map("joined_at")

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@map("project_members")
}

enum ProjectRole {
  OWNER
  ADMIN
  MANAGER
  DEVELOPER
  VIEWER

  @@map("project_role")
}

// Workflow Management
model Workflow {
  id          String             @id @default(cuid())
  name        String
  description String?
  type        WorkflowType
  status      WorkflowStatus     @default(DRAFT)
  projectId   String?            @map("project_id") // null for global workflows
  isDefault   Boolean            @default(false) @map("is_default")
  states      Json               // WorkflowState[]
  transitions Json               // WorkflowTransition[]
  createdBy   String             @map("created_by")
  version     Int                @default(1)
  metadata    Json?
  createdAt   DateTime           @default(now()) @map("created_at")
  updatedAt   DateTime           @updatedAt @map("updated_at")

  // Relations
  project           Project?                  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks             Task[]
  issues            Issue[]
  transitionLogs    WorkflowTransitionLog[]

  @@map("workflows")
}

enum WorkflowType {
  TASK
  ISSUE
  EPIC
  STORY
  BUG

  @@map("workflow_type")
}

enum WorkflowStatus {
  ACTIVE
  INACTIVE
  DRAFT

  @@map("workflow_status")
}

model WorkflowTransitionLog {
  id           String   @id @default(cuid())
  workflowId   String   @map("workflow_id")
  transitionId String   @map("transition_id")
  entityId     String   @map("entity_id")
  entityType   String   @map("entity_type")
  userId       String   @map("user_id")
  fromStateId  String   @map("from_state_id")
  toStateId    String   @map("to_state_id")
  executedAt   DateTime @default(now()) @map("executed_at")
  metadata     Json?

  // Relations
  workflow Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@map("workflow_transition_logs")
}

// Project Configuration
model ProjectConfiguration {
  id           String   @id @default(cuid())
  projectId    String   @unique @map("project_id")
  settings     Json     // ProjectSettings
  workflows    String[] // workflow IDs
  templates    Json[]   // ProjectTemplate[]
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  project      Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  customFields CustomField[]

  @@map("project_configurations")
}

model ProjectTemplate {
  id            String   @id @default(cuid())
  name          String
  description   String?
  category      String
  methodology   String
  isPublic      Boolean  @default(false) @map("is_public")
  configuration Json     // Partial<ProjectSettings>
  workflows     String[] // workflow IDs
  customFields  String[] // custom field IDs
  defaultRoles  Json[]   // TemplateRole[]
  sampleTasks   Json[]   // TemplateTasks[]
  createdBy     String   @map("created_by")
  usageCount    Int      @default(0) @map("usage_count")
  rating        Float?
  tags          String[]
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("project_templates")
}

// Task Management (Main work items)
model Task {
  id              String    @id @default(cuid())
  key             String    @unique // e.g., "MAR-123"
  title           String
  description     String?
  type            TaskType
  status          String    @default("TODO") // Current status name
  currentStateId  String?   @map("current_state_id") // Current workflow state ID
  workflowId      String?   @map("workflow_id") // Associated workflow
  priority        Priority?
  assigneeId      String?   @map("assignee_id")
  reporterId      String    @map("reporter_id")
  projectId       String    @map("project_id")
  parentId        String?   @map("parent_id")
  estimatedHours  Decimal?  @db.Decimal(8, 2) @map("estimated_hours")
  remainingHours  Decimal?  @db.Decimal(8, 2) @map("remaining_hours")
  loggedHours     Decimal   @default(0) @db.Decimal(8, 2) @map("logged_hours")
  dueDate         DateTime? @map("due_date")
  labels          String[]
  components      String[]
  storyPoints     Int?      @map("story_points")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  workflow            Workflow?          @relation(fields: [workflowId], references: [id])
  assignee            User?              @relation("TaskAssignee", fields: [assigneeId], references: [id])
  reporter            User               @relation("TaskReporter", fields: [reporterId], references: [id])
  project             Project            @relation(fields: [projectId], references: [id], onDelete: Cascade)
  parent              Task?              @relation("TaskHierarchy", fields: [parentId], references: [id])
  subtasks            Task[]             @relation("TaskHierarchy")
  dependencies        TaskDependency[]   @relation("DependentTask")
  dependents          TaskDependency[]   @relation("BlockingTask")
  issues              Issue[]            // Tasks can have multiple issues
  attachments         Attachment[]
  comments            Comment[]
  timeEntries         TimeEntry[]
  customFieldValues   TaskCustomFieldValue[]
  sprintTasks         SprintTask[]
  backlogItem         BacklogItem?

  @@map("tasks")
}

enum TaskType {
  EPIC
  STORY
  TASK
  SUBTASK

  @@map("task_type")
}

model TaskDependency {
  id              String         @id @default(cuid())
  dependentTaskId String         @map("dependent_task_id")
  blockingTaskId  String         @map("blocking_task_id")
  type            DependencyType
  createdAt       DateTime       @default(now()) @map("created_at")

  // Relations
  dependentTask Task @relation("DependentTask", fields: [dependentTaskId], references: [id], onDelete: Cascade)
  blockingTask  Task @relation("BlockingTask", fields: [blockingTaskId], references: [id], onDelete: Cascade)

  @@unique([dependentTaskId, blockingTaskId])
  @@map("task_dependencies")
}

enum DependencyType {
  BLOCKS
  IS_BLOCKED_BY
  RELATES_TO

  @@map("dependency_type")
}

// Issue Management (Problems/Bugs within tasks)
model Issue {
  id              String    @id @default(cuid())
  key             String    @unique // e.g., "MAR-BUG-001"
  title           String
  description     String?
  type            IssueType
  status          String    @default("OPEN") // Current status name
  currentStateId  String?   @map("current_state_id") // Current workflow state ID
  workflowId      String?   @map("workflow_id") // Associated workflow
  priority        Priority?
  severity        IssueSeverity?
  assigneeId      String?   @map("assignee_id")
  reporterId      String    @map("reporter_id")
  projectId       String    @map("project_id")
  taskId          String?   @map("task_id") // Issues can be linked to tasks
  environment     String?   // e.g., "Production", "Staging", "Development"
  stepsToReproduce String?  @map("steps_to_reproduce")
  expectedBehavior String?  @map("expected_behavior")
  actualBehavior   String?  @map("actual_behavior")
  labels          String[]
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  workflow            Workflow?          @relation(fields: [workflowId], references: [id])
  assignee            User?              @relation("IssueAssignee", fields: [assigneeId], references: [id])
  reporter            User               @relation("IssueReporter", fields: [reporterId], references: [id])
  project             Project            @relation(fields: [projectId], references: [id], onDelete: Cascade)
  task                Task?              @relation(fields: [taskId], references: [id])
  attachments         Attachment[]
  comments            Comment[]
  timeEntries         TimeEntry[]
  customFieldValues   IssueCustomFieldValue[]

  @@map("issues")
}

enum IssueType {
  BUG
  DEFECT
  IMPROVEMENT
  ENHANCEMENT
  SUPPORT

  @@map("issue_type")
}

enum IssueSeverity {
  CRITICAL
  HIGH
  MEDIUM
  LOW
  TRIVIAL

  @@map("issue_severity")
}

// Agile/Scrum Management
model Sprint {
  id          String      @id @default(cuid())
  name        String
  goal        String?
  projectId   String      @map("project_id")
  startDate   DateTime    @map("start_date")
  endDate     DateTime    @map("end_date")
  status      SprintStatus
  capacity    Int?
  velocity    Int?
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  // Relations
  project     Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  sprintTasks SprintTask[]

  @@map("sprints")
}

enum SprintStatus {
  PLANNING
  ACTIVE
  COMPLETED
  CANCELLED

  @@map("sprint_status")
}

model SprintTask {
  id       String @id @default(cuid())
  sprintId String @map("sprint_id")
  taskId   String @map("task_id")
  addedAt  DateTime @default(now()) @map("added_at")

  // Relations
  sprint Sprint @relation(fields: [sprintId], references: [id], onDelete: Cascade)
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@unique([sprintId, taskId])
  @@map("sprint_tasks")
}

model Backlog {
  id            String        @id @default(cuid())
  projectId     String        @unique @map("project_id")
  priorityOrder String[]      @map("priority_order")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  items   BacklogItem[]
  refinements BacklogRefinement[]

  @@map("backlogs")
}

// Epic Management
model Epic {
  id            String      @id @default(cuid())
  key           String      @unique // e.g., "MAR-EPIC-001"
  title         String
  description   String?
  projectId     String      @map("project_id")
  status        EpicStatus  @default(DRAFT)
  priority      Priority?
  ownerId       String      @map("owner_id")
  startDate     DateTime?   @map("start_date")
  targetDate    DateTime?   @map("target_date")
  businessValue Int?        @map("business_value")
  storyPoints   Int?        @map("story_points")
  progress      Int         @default(0) // 0-100 percentage
  color         String?
  labels        String[]
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  // Relations
  project       Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  owner         User          @relation("EpicOwner", fields: [ownerId], references: [id])
  backlogItems  BacklogItem[]

  @@map("epics")
}

enum EpicStatus {
  DRAFT
  PLANNED
  IN_PROGRESS
  COMPLETED
  CANCELLED

  @@map("epic_status")
}

// Backlog Item Management
model BacklogItem {
  id                  String     @id @default(cuid())
  taskId              String     @unique @map("task_id")
  backlogId           String     @map("backlog_id")
  priority            Int        @default(0)
  storyPoints         Int?       @map("story_points")
  epicId              String?    @map("epic_id")
  businessValue       Int?       @map("business_value")
  riskLevel           RiskLevel  @default(MEDIUM) @map("risk_level")
  readyForSprint      Boolean    @default(false) @map("ready_for_sprint")
  acceptanceCriteria  String[]   @map("acceptance_criteria")
  dependencies        String[]   // Task IDs that this item depends on
  labels              String[]
  estimatedHours      Decimal?   @db.Decimal(8, 2) @map("estimated_hours")
  createdAt           DateTime   @default(now()) @map("created_at")
  updatedAt           DateTime   @updatedAt @map("updated_at")

  // Relations
  task                Task       @relation(fields: [taskId], references: [id], onDelete: Cascade)
  backlog             Backlog    @relation(fields: [backlogId], references: [id], onDelete: Cascade)
  epic                Epic?      @relation(fields: [epicId], references: [id])

  @@map("backlog_items")
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL

  @@map("risk_level")
}

// Backlog Refinement Sessions
model BacklogRefinement {
  id                      String   @id @default(cuid())
  backlogId               String   @map("backlog_id")
  conductedBy             String   @map("conducted_by")
  conductedAt             DateTime @map("conducted_at")
  itemsRefined            String[] @map("items_refined")
  estimationsUpdated      String[] @map("estimations_updated")
  criteriaAdded           String[] @map("criteria_added")
  dependenciesIdentified  String[] @map("dependencies_identified")
  notes                   String?
  nextRefinementDate      DateTime? @map("next_refinement_date")
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")

  // Relations
  backlog                 Backlog  @relation(fields: [backlogId], references: [id], onDelete: Cascade)
  facilitator             User     @relation("RefinementFacilitator", fields: [conductedBy], references: [id])

  @@map("backlog_refinements")
}

// Estimation Sessions
model EstimationSession {
  id                String            @id @default(cuid())
  projectId         String            @map("project_id")
  facilitatorId     String            @map("facilitator_id")
  participants      String[]
  itemsEstimated    String[]          @map("items_estimated")
  estimationMethod  EstimationMethod  @map("estimation_method")
  sessionDate       DateTime          @map("session_date")
  duration          Int               // minutes
  consensus         Json[]            // EstimationConsensus[]
  notes             String?
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")

  // Relations
  project           Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  facilitator       User              @relation("EstimationFacilitator", fields: [facilitatorId], references: [id])

  @@map("estimation_sessions")
}

enum EstimationMethod {
  PLANNING_POKER
  T_SHIRT_SIZING
  FIBONACCI
  LINEAR
  RELATIVE

  @@map("estimation_method")
}

// Comments and Communication (Shared between Tasks and Issues)
model Comment {
  id        String   @id @default(cuid())
  taskId    String?  @map("task_id")
  issueId   String?  @map("issue_id")
  authorId  String   @map("author_id")
  content   String
  parentId  String?  @map("parent_id")
  mentions  String[]
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  task     Task?     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  issue    Issue?    @relation(fields: [issueId], references: [id], onDelete: Cascade)
  author   User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  parent   Comment?  @relation("CommentThread", fields: [parentId], references: [id])
  replies  Comment[] @relation("CommentThread")

  @@map("comments")
}

// Time Tracking (Shared between Tasks and Issues)
model TimeEntry {
  id          String    @id @default(cuid())
  taskId      String?   @map("task_id")
  issueId     String?   @map("issue_id")
  userId      String    @map("user_id")
  hours       Decimal   @db.Decimal(8, 2)
  description String?
  date        DateTime
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  task  Task?  @relation(fields: [taskId], references: [id], onDelete: Cascade)
  issue Issue? @relation(fields: [issueId], references: [id], onDelete: Cascade)
  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("time_entries")
}

// File Attachments (Shared between Tasks and Issues)
model Attachment {
  id           String   @id @default(cuid())
  taskId       String?  @map("task_id")
  issueId      String?  @map("issue_id")
  filename     String
  originalName String   @map("original_name")
  mimeType     String   @map("mime_type")
  size         Int
  path         String
  uploadedBy   String   @map("uploaded_by")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  task  Task?  @relation(fields: [taskId], references: [id], onDelete: Cascade)
  issue Issue? @relation(fields: [issueId], references: [id], onDelete: Cascade)

  @@map("attachments")
}

// Custom Fields
model CustomField {
  id                    String          @id @default(cuid())
  projectId             String?         @map("project_id") // null for global fields
  configurationId       String?         @map("configuration_id")
  name                  String
  description           String?
  type                  CustomFieldType
  required              Boolean         @default(false)
  defaultValue          Json?           @map("default_value")
  options               Json[]          // CustomFieldOption[]
  validation            Json?           // CustomFieldValidation
  position              Int
  isActive              Boolean         @default(true) @map("is_active")
  appliesTo             String[]        @map("applies_to") // WorkflowType[]
  metadata              Json?
  createdBy             String          @map("created_by")
  createdAt             DateTime        @default(now()) @map("created_at")
  updatedAt             DateTime        @updatedAt @map("updated_at")

  // Relations
  project               Project?                   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  configuration         ProjectConfiguration?      @relation(fields: [configurationId], references: [id], onDelete: Cascade)
  taskValues            TaskCustomFieldValue[]
  issueValues           IssueCustomFieldValue[]

  @@unique([projectId, name])
  @@map("custom_fields")
}

enum CustomFieldType {
  TEXT
  NUMBER
  DATE
  DATETIME
  BOOLEAN
  SELECT
  MULTI_SELECT
  USER
  MULTI_USER
  URL
  EMAIL
  TEXTAREA
  RICH_TEXT
  FILE

  @@map("custom_field_type")
}

model TaskCustomFieldValue {
  id            String      @id @default(cuid())
  customFieldId String      @map("custom_field_id")
  taskId        String      @map("task_id")
  value         Json

  // Relations
  customField CustomField @relation(fields: [customFieldId], references: [id], onDelete: Cascade)
  task        Task        @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@unique([customFieldId, taskId])
  @@map("task_custom_field_values")
}

model IssueCustomFieldValue {
  id            String      @id @default(cuid())
  customFieldId String      @map("custom_field_id")
  issueId       String      @map("issue_id")
  value         Json

  // Relations
  customField CustomField @relation(fields: [customFieldId], references: [id], onDelete: Cascade)
  issue       Issue       @relation(fields: [issueId], references: [id], onDelete: Cascade)

  @@unique([customFieldId, issueId])
  @@map("issue_custom_field_values")
}

// Notifications
model Notification {
  id        String           @id @default(cuid())
  userId    String           @map("user_id")
  type      NotificationType
  title     String
  message   String
  data      Json?
  isRead    Boolean          @default(false) @map("is_read")
  createdAt DateTime         @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

enum NotificationType {
  TASK_ASSIGNED
  TASK_UPDATED
  TASK_COMMENTED
  ISSUE_ASSIGNED
  ISSUE_UPDATED
  ISSUE_COMMENTED
  DEADLINE_APPROACHING
  SPRINT_STARTED
  SPRINT_COMPLETED
  PROJECT_UPDATED
  TEAM_UPDATED

  @@map("notification_type")
}

// Audit Logging
model AuditLog {
  id         String   @id @default(cuid())
  userId     String?  @map("user_id")
  action     String
  resource   String
  resourceId String   @map("resource_id")
  oldValues  Json?    @map("old_values")
  newValues  Json?    @map("new_values")
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  user User? @relation(fields: [userId], references: [id])

  @@map("audit_logs")
}